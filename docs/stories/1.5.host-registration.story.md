# Story 1.5: Host Registration & Profile

## Status

Draft

## Story

**As a** user with a washing machine,
**I want** to register as a host,
**so that** I can offer my laundry services and earn money.

## Acceptance Criteria

1. "Become a Host" option accessible from user profile/settings
2. Host registration flow: address input, machine details, profile photo
3. Address input with autocomplete (Google Places API or similar)
4. Location coordinates stored for proximity search (PostGIS geography type)
5. Database table `hosts` created (user_id FK, address, location, machine_type, is_active, created_at)
6. Host profile linked to user profile (one-to-one relationship)
7. Host can upload photos of their space/machine (Supabase Storage)
8. Host registration sets `is_active = false` initially (activated after setup complete)

## Tasks / Subtasks

- [ ] Task 1: Enable PostGIS extension in Supabase (AC: 4)
  - [ ] Enable `postgis` extension via Supabase Dashboard or SQL
  - [ ] Verify extension is active with `SELECT PostGIS_Version();`

- [ ] Task 2: Create hosts table migration (AC: 5, 6)
  - [ ] Create `hosts` table with PostGIS geography column
  - [ ] Add foreign key to `profiles` table
  - [ ] Add unique constraint on `user_id` (one host per user)
  - [ ] Create RLS policies for hosts table
  - [ ] Apply migration via Supabase MCP

- [ ] Task 3: Create host_photos storage bucket (AC: 7)
  - [ ] Create `host-photos` bucket in Supabase Storage
  - [ ] Configure RLS policies: public read, owner upload/update
  - [ ] Set file size limit (5MB max per photo)
  - [ ] Set allowed MIME types (image/jpeg, image/png, image/webp)

- [ ] Task 4: Configure Google Places API (AC: 3)
  - [ ] Create Google Cloud project (if not exists)
  - [ ] Enable Places API
  - [ ] Generate API key with appropriate restrictions
  - [ ] Add `EXPO_PUBLIC_GOOGLE_PLACES_API_KEY` to environment variables

- [ ] Task 5: Install dependencies (AC: 3)
  - [ ] Install `react-native-google-places-autocomplete` or use Google Places API directly
  - [ ] Verify `expo-location` is available for getting current location

- [ ] Task 6: Create HostRegistrationScreen - Step 1: Address (AC: 2, 3, 4)
  - [ ] Create `src/screens/host/HostRegistrationScreen.tsx`
  - [ ] Implement multi-step wizard UI (Step 1 of 3: Address)
  - [ ] Add Google Places Autocomplete input for address
  - [ ] Extract and store coordinates (lat, lng) from selected place
  - [ ] Show map preview with marker at selected location
  - [ ] Add "Next" button to proceed to step 2

- [ ] Task 7: Create HostRegistrationScreen - Step 2: Machine Details (AC: 2)
  - [ ] Add Step 2: Machine Details
  - [ ] Add machine type dropdown/selector (e.g., "Front-load washer", "Top-load washer", "Washer-dryer combo")
  - [ ] Add optional description/bio text input
  - [ ] Add "Next" button to proceed to step 3

- [ ] Task 8: Create HostRegistrationScreen - Step 3: Photos (AC: 2, 7)
  - [ ] Add Step 3: Photos
  - [ ] Allow multiple photo uploads (up to 5 photos)
  - [ ] Reuse image picker logic from Story 1.4
  - [ ] Upload photos to `host-photos/{host_id}/` folder
  - [ ] Show photo previews with delete option
  - [ ] Add "Complete Registration" button

- [ ] Task 9: Implement host registration hook (AC: 5, 6, 8)
  - [ ] Create `src/hooks/useHost.ts`
  - [ ] Implement `registerAsHost(data)` function
  - [ ] Create host record in database with `is_active = false`
  - [ ] Store location as PostGIS geography point
  - [ ] Return created host record

- [ ] Task 10: Add "Become a Host" entry point (AC: 1)
  - [ ] Update Profile/Settings screen
  - [ ] Add "Become a Host" button/card (visible only if not already a host)
  - [ ] Navigate to HostRegistrationScreen on tap
  - [ ] Show "You're a host!" status if already registered

- [ ] Task 11: Update authStore with host status (AC: 6)
  - [ ] Add `host` field to authStore
  - [ ] Fetch host record on app load if user is a host
  - [ ] Create `isHost` computed property

- [ ] Task 12: Write tests for host registration
  - [ ] Test HostRegistrationScreen renders all steps
  - [ ] Test address autocomplete interaction (mocked)
  - [ ] Test form validation
  - [ ] Test host creation with mocked Supabase
  - [ ] Test "Become a Host" visibility logic

## Dev Notes

### Host Data Model
[Source: docs/architecture.md#section-4.2]

```typescript
interface Host {
  id: string;
  user_id: string;
  address: string;
  location: {
    type: 'Point';
    coordinates: [number, number]; // [lng, lat] - GeoJSON format
  };
  description: string | null;
  machine_type: string;
  is_active: boolean;
  rating_avg: number;
  rating_count: number;
  stripe_account_id: string | null;
  stripe_onboarding_complete: boolean;
  created_at: string;
  updated_at: string;
}

// Machine type options
type MachineType =
  | 'front_load_washer'
  | 'top_load_washer'
  | 'washer_dryer_combo'
  | 'commercial_washer';
```

### Database Migration for Hosts Table
```sql
-- Enable PostGIS extension
CREATE EXTENSION IF NOT EXISTS postgis;

-- Create hosts table
CREATE TABLE hosts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  address TEXT NOT NULL,
  location GEOGRAPHY(POINT, 4326) NOT NULL,
  description TEXT,
  machine_type TEXT NOT NULL,
  is_active BOOLEAN DEFAULT false,
  rating_avg DECIMAL(2,1) DEFAULT 0,
  rating_count INTEGER DEFAULT 0,
  stripe_account_id TEXT,
  stripe_onboarding_complete BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT hosts_user_id_key UNIQUE (user_id)
);

-- Create index for geospatial queries
CREATE INDEX hosts_location_idx ON hosts USING GIST (location);

-- Create index for active hosts
CREATE INDEX hosts_is_active_idx ON hosts (is_active) WHERE is_active = true;

-- RLS Policies
ALTER TABLE hosts ENABLE ROW LEVEL SECURITY;

-- Anyone can view active hosts
CREATE POLICY "Active hosts are viewable by everyone"
ON hosts FOR SELECT
USING (is_active = true);

-- Users can view their own host profile (even if inactive)
CREATE POLICY "Users can view own host profile"
ON hosts FOR SELECT
USING (auth.uid() = user_id);

-- Users can insert their own host profile
CREATE POLICY "Users can create own host profile"
ON hosts FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- Users can update their own host profile
CREATE POLICY "Users can update own host profile"
ON hosts FOR UPDATE
USING (auth.uid() = user_id);
```

### Host Photos Storage Configuration
```sql
-- Create host-photos bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('host-photos', 'host-photos', true);

-- RLS Policy: Anyone can view host photos
CREATE POLICY "Host photos are publicly accessible"
ON storage.objects FOR SELECT
USING (bucket_id = 'host-photos');

-- RLS Policy: Hosts can upload their own photos
CREATE POLICY "Hosts can upload own photos"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'host-photos' AND
  auth.uid()::text = (storage.foldername(name))[1]
);

-- RLS Policy: Hosts can delete their own photos
CREATE POLICY "Hosts can delete own photos"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'host-photos' AND
  auth.uid()::text = (storage.foldername(name))[1]
);
```

### Google Places Autocomplete Pattern
```typescript
// components/AddressAutocomplete.tsx
import { GooglePlacesAutocomplete } from 'react-native-google-places-autocomplete';

interface AddressResult {
  address: string;
  coordinates: {
    lat: number;
    lng: number;
  };
}

interface Props {
  onSelect: (result: AddressResult) => void;
}

export function AddressAutocomplete({ onSelect }: Props) {
  return (
    <GooglePlacesAutocomplete
      placeholder="Enter your address"
      onPress={(data, details) => {
        if (details) {
          onSelect({
            address: data.description,
            coordinates: {
              lat: details.geometry.location.lat,
              lng: details.geometry.location.lng,
            },
          });
        }
      }}
      query={{
        key: process.env.EXPO_PUBLIC_GOOGLE_PLACES_API_KEY,
        language: 'en',
        components: 'country:fr', // Restrict to France
      }}
      fetchDetails={true}
      styles={{
        textInput: {
          height: 50,
          borderWidth: 1,
          borderColor: '#ccc',
          borderRadius: 8,
          paddingHorizontal: 16,
        },
      }}
    />
  );
}
```

### Host Registration Hook Pattern
```typescript
// hooks/useHost.ts
import { supabase } from '@/services/supabase';
import { useAuthStore } from '@/stores/authStore';

interface HostRegistrationData {
  address: string;
  coordinates: { lat: number; lng: number };
  machineType: string;
  description?: string;
  photoUrls?: string[];
}

export function useHost() {
  const { user, setHost } = useAuthStore();

  const registerAsHost = async (data: HostRegistrationData) => {
    if (!user) throw new Error('Not authenticated');

    // Create PostGIS point from coordinates
    // Note: PostGIS uses (lng, lat) order (GeoJSON format)
    const locationPoint = `POINT(${data.coordinates.lng} ${data.coordinates.lat})`;

    const { data: host, error } = await supabase
      .from('hosts')
      .insert({
        user_id: user.id,
        address: data.address,
        location: locationPoint,
        machine_type: data.machineType,
        description: data.description || null,
        is_active: false, // AC 8: Start inactive
      })
      .select()
      .single();

    if (error) throw error;
    setHost(host);
    return host;
  };

  const getHostProfile = async () => {
    if (!user) return null;

    const { data: host } = await supabase
      .from('hosts')
      .select('*')
      .eq('user_id', user.id)
      .single();

    return host;
  };

  return { registerAsHost, getHostProfile };
}
```

### Multi-Step Form State Pattern
```typescript
// screens/host/HostRegistrationScreen.tsx
import { useState } from 'react';

type Step = 'address' | 'machine' | 'photos';

interface RegistrationData {
  address: string;
  coordinates: { lat: number; lng: number } | null;
  machineType: string;
  description: string;
  photos: string[];
}

export function HostRegistrationScreen() {
  const [step, setStep] = useState<Step>('address');
  const [data, setData] = useState<RegistrationData>({
    address: '',
    coordinates: null,
    machineType: '',
    description: '',
    photos: [],
  });

  const canProceed = {
    address: data.address && data.coordinates,
    machine: data.machineType,
    photos: true, // Photos are optional
  };

  // ... render steps based on current step
}
```

### Update AuthStore for Host Status
```typescript
// stores/authStore.ts - Updated
interface AuthState {
  user: Profile | null;
  host: Host | null;  // Add host field
  isLoading: boolean;
  setUser: (user: Profile | null) => void;
  setHost: (host: Host | null) => void;
  signOut: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      host: null,
      isLoading: false,
      setUser: (user) => set({ user }),
      setHost: (host) => set({ host }),
      signOut: () => set({ user: null, host: null }),
    }),
    {
      name: 'auth-storage',
      storage: createJSONStorage(() => AsyncStorage),
    }
  )
);

// Computed helper
export const useIsHost = () => useAuthStore((state) => !!state.host);
```

### Source Tree for Host Registration
```
src/
├── screens/
│   └── host/
│       └── HostRegistrationScreen.tsx  # To be created (multi-step wizard)
├── components/
│   └── host/
│       ├── AddressAutocomplete.tsx     # To be created
│       ├── MachineTypeSelector.tsx     # To be created
│       └── PhotoGalleryUploader.tsx    # To be created
├── hooks/
│   ├── useHost.ts                      # To be created
│   └── useImagePicker.ts               # From Story 1.4
├── stores/
│   └── authStore.ts                    # Update - add host field
└── types/
    └── database.ts                     # Update - add Host type
```

### Environment Variables

```bash
# apps/mobile-web/.env.local - Add
EXPO_PUBLIC_GOOGLE_PLACES_API_KEY=AIzaSy...
```

### Dependencies to Install

```bash
npm install react-native-google-places-autocomplete
npx expo install expo-location
```

### Testing

**Test Location:** `apps/mobile-web/__tests__/`

**Testing Framework:** Jest + @testing-library/react

**Required Tests:**
- `__tests__/screens/HostRegistrationScreen.test.tsx`
- `__tests__/hooks/useHost.test.ts`
- `__tests__/components/AddressAutocomplete.test.tsx`

**Testing Pattern:**
```typescript
// Mock Google Places Autocomplete
jest.mock('react-native-google-places-autocomplete', () => ({
  GooglePlacesAutocomplete: ({ onPress }: any) => {
    return (
      <button
        data-testid="places-autocomplete"
        onClick={() => onPress(
          { description: '123 Test St, Paris, France' },
          { geometry: { location: { lat: 48.8566, lng: 2.3522 } } }
        )}
      />
    );
  },
}));
```

### Important Notes

- PostGIS uses (longitude, latitude) order, which is opposite to most mapping APIs that use (lat, lng). Be careful when converting coordinates.
- Google Places API has usage costs. Consider caching results or using alternative free services for MVP testing.
- Host photos should be separate from avatar photos (different bucket, different limits).
- `is_active = false` ensures hosts complete additional setup (availability, services) before appearing in search results.

### Future Considerations (Not in This Story)

- Host services setup (pricing, service types) - Epic 2
- Host availability calendar - Epic 2
- Stripe Connect onboarding - Epic 6
- Host activation workflow

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | Sarah (PO) |
