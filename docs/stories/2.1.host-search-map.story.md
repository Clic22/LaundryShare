# Story 2.1: Host Search - Map View

## Status

Done

## Story

**As a** user,
**I want** to see nearby hosts on a map,
**so that** I can find hosts close to my location.

## Acceptance Criteria

1. ✅ Map view as default home screen (User mode)
2. ✅ User's current location detected and centered on map
3. ✅ Active hosts displayed as markers on map
4. ✅ Markers show basic info on tap (host name, rating, distance)
5. ✅ PostGIS query returns hosts within configurable radius (default 5km)
6. ✅ Map allows pan and zoom with marker clustering for dense areas
7. ✅ Permission handling for location access (request, denied state, manual entry fallback)
8. ✅ "Search this area" button to refresh results after map movement

## Implementation Details

### Database

- **PostGIS Extension**: Already enabled in Supabase (version 3.3.7)
- **hosts table**: Contains `location` column of type `GEOGRAPHY(POINT, 4326)`
- **RPC Function**: `get_nearby_hosts(user_lat, user_lng, radius_km)`
  - Returns: id, user_id, address, latitude, longitude, distance_km, description, machine_type, rating_avg, rating_count, full_name, avatar_url
  - Uses `ST_Distance` for distance calculation
  - Uses `ST_DWithin` for proximity filtering
  - Orders results by distance (nearest first)

### Hooks

**useLocation** (`src/hooks/useLocation.ts`)
- Manages user location with expo-location
- Requests foreground location permissions
- Provides current location coordinates
- Handles permission errors and loading states
- Includes refresh functionality

**useNearbyHosts** (`src/hooks/useNearbyHosts.ts`)
- Fetches nearby hosts via Supabase RPC
- Takes latitude, longitude, and radius as parameters
- Returns hosts array, loading state, and error
- Includes refetch method for manual refresh

### Components

**HostMapView** (`src/components/map/HostMapView.tsx`)
- React Native Maps MapView component
- Displays user location with default marker
- Shows host markers with green pins
- Interactive callouts showing:
  - Host name
  - Rating and review count
  - Distance in kilometers
  - Description (truncated)
- "Search this area" button (appears when map is moved >500m)
- Recenter button to return to user location
- Host count indicator
- Loading states and permission error handling

**HomeScreen** (`src/screens/user/HomeScreen.tsx` & `.web.tsx`)
- Native version: Renders HostMapView
- Web version: Shows placeholder (react-native-maps not web-compatible)
- Platform-specific files for proper bundling

### Dependencies

- `react-native-maps@1.20.1` - Map component (iOS/Android only)
- `expo-location@~19.0.8` - Location permissions and coordinates
- `react-native-reanimated@~4.1.1` - Smooth animations

## Platform Notes

**iOS/Android**: Full map functionality with react-native-maps
**Web**: Shows placeholder message since react-native-maps is native-only

The platform-specific file approach (`HomeScreen.web.tsx`) ensures clean web builds without attempting to bundle native modules.

## Testing

- Location permissions tested (grant/deny scenarios)
- Map interaction tested (pan, zoom, recenter)
- Host markers display correctly with accurate coordinates
- Callouts show proper host information
- "Search this area" appears after significant map movement
- PostGIS query returns accurate distance calculations

## Deployment

- Deployed to Vercel: https://laundry-jpopks4su-clic22s-projects.vercel.app
- Commits: fd3235f, 2a38411, 86c5f41, 3d68fd6
- All migrations applied to Supabase production

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Story 2.1 completed | Claude Sonnet 4.5 |
