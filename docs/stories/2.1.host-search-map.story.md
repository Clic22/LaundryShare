# Story 2.1: Host Search - Map View

## Status

Done

## Story

**As a** user,
**I want** to see nearby hosts on a map,
**so that** I can find hosts close to my location.

## Acceptance Criteria

1. ✅ Map view as default home screen (User mode)
2. ✅ User's current location detected and centered on map
3. ✅ Active hosts displayed as markers on map
4. ✅ Markers show basic info on tap (host name, rating, distance)
5. ✅ PostGIS query returns hosts within configurable radius (default 5km)
6. ✅ Map allows pan and zoom with marker clustering for dense areas
7. ✅ Permission handling for location access (request, denied state, manual entry fallback)
8. ✅ "Search this area" button to refresh results after map movement

## Implementation Details

### Database

- **PostGIS Extension**: Already enabled in Supabase (version 3.3.7)
- **hosts table**: Contains `location` column of type `GEOGRAPHY(POINT, 4326)`
- **RPC Function**: `get_nearby_hosts(user_lat, user_lng, radius_km)`
  - Returns: id, user_id, address, latitude, longitude, distance_km, description, machine_type, rating_avg, rating_count, full_name, avatar_url
  - Uses `ST_Distance` for distance calculation
  - Uses `ST_DWithin` for proximity filtering
  - Orders results by distance (nearest first)

### Hooks

**useLocation** (`src/hooks/useLocation.ts`)
- Manages user location with expo-location
- Requests foreground location permissions
- Provides current location coordinates
- Handles permission errors and loading states
- Includes refresh functionality

**useNearbyHosts** (`src/hooks/useNearbyHosts.ts`)
- Fetches nearby hosts via Supabase RPC
- Takes latitude, longitude, and radius as parameters
- Returns hosts array, loading state, and error
- Includes refetch method for manual refresh

### Components

**HostMapView** (`src/components/map/HostMapView.tsx`)
- React Native Maps MapView component (iOS/Android)
- Displays user location with default marker
- Shows host markers with green pins
- Interactive callouts showing:
  - Host name
  - Rating and review count
  - Distance in kilometers
  - Description (truncated)
- "Search this area" button (appears when map is moved >500m)
- Recenter button to return to user location
- Host count indicator
- Loading states and permission error handling

**HostMapView.web** (`src/components/map/HostMapView.web.tsx`)
- Leaflet MapContainer component (Web)
- OpenStreetMap tile layer
- User location marker with blue default icon
- Host markers with custom green icons
- Interactive popups showing same info as native callouts
- MapController for centering and move detection
- Same "Search this area" and recenter functionality as native
- Identical loading states and error handling

**HomeScreen** (`src/screens/user/HomeScreen.tsx` & `.web.tsx`)
- Native version: Renders HostMapView (react-native-maps)
- Web version: Renders HostMapView (Leaflet)
- Platform-specific files ensure proper bundling for each platform

### Dependencies

- `react-native-maps@1.20.1` - Map component (iOS/Android only)
- `expo-location@~19.0.8` - Location permissions and coordinates
- `react-native-reanimated@~4.1.1` - Smooth animations
- `react-leaflet@^5.0.0` - React components for Leaflet (Web only)
- `leaflet@^1.9.4` - Interactive maps library (Web only)
- `@types/leaflet@^1.9.21` - TypeScript types for Leaflet

## Platform Notes

**iOS/Android**: Full map functionality with react-native-maps (Google Maps provider)

**Web**: Full map functionality with Leaflet and OpenStreetMap tiles

- No API keys required (free and open-source)
- Feature parity with native version
- Custom marker icons and interactive popups
- Same "Search this area" and recenter functionality

The platform-specific file approach (`HomeScreen.web.tsx` and `HostMapView.web.tsx`) ensures clean builds without attempting to bundle incompatible modules for each platform.

## Testing

- Location permissions tested (grant/deny scenarios)
- Map interaction tested (pan, zoom, recenter)
- Host markers display correctly with accurate coordinates
- Callouts show proper host information
- "Search this area" appears after significant map movement
- PostGIS query returns accurate distance calculations

## Deployment

- Deployed to Vercel: https://laundry-jpopks4su-clic22s-projects.vercel.app
- Initial commits: fd3235f, 2a38411, 86c5f41, 3d68fd6
- Web map enhancement: 39d940c
- All migrations applied to Supabase production

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Story 2.1 completed (native iOS/Android) | Claude Sonnet 4.5 |
| 2026-01-07 | 1.1 | Added full web support with Leaflet | Claude Sonnet 4.5 |
