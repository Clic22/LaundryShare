# Story 1.3: User Authentication - Social Login

## Status

Complete

## Story

**As a** user,
**I want** to sign up and log in with Google,
**so that** I can access the platform quickly without creating a new password.

## Acceptance Criteria

1. ✅ Google Sign-In button on login/signup screens
2. ⏸️ Apple Sign-In button (deferred - requires Apple Developer account)
3. ✅ Supabase Auth OAuth integration for Google
4. ✅ New users via social login have profile created automatically
5. ⏸️ Existing users can link social accounts (future enhancement - not MVP)
6. ✅ Error handling for cancelled or failed OAuth flow

## Tasks / Subtasks

- [x] Task 1: Configure OAuth providers in Supabase (AC: 3)
  - [x] Enable Google OAuth provider in Supabase Dashboard
  - [x] Configure Google OAuth credentials (Client ID, Client Secret)
  - [ ] ~~Enable Apple OAuth provider~~ (deferred - no Apple Developer account)
  - [x] Configure redirect URLs for Expo Go and web

- [x] Task 2: Install OAuth dependencies (AC: 3)
  - [x] Install `expo-auth-session` for OAuth flow
  - [x] Install `expo-crypto` (required by expo-auth-session)
  - [x] Install `expo-web-browser` for OAuth redirect

- [x] Task 3: Create OAuth hook (AC: 3, 4)
  - [x] Create `src/hooks/useOAuth.ts` with Google sign-in
  - [x] Implement `signInWithGoogle()` using Supabase OAuth
  - [x] Handle OAuth callback and session extraction
  - [x] Platform-specific redirect URI handling (web vs Expo Go)
  - [x] JWT decoding for immediate user state (workaround for setSession hanging)

- [x] Task 4: Update Login screen with social buttons (AC: 1)
  - [x] Add Google Sign-In button below email/password form
  - [x] Add visual separator ("or continue with") between form and social buttons
  - [x] Style button according to Google brand guidelines

- [x] Task 5: Update Signup screen with social buttons (AC: 1)
  - [x] Add Google Sign-In button below signup form
  - [x] Add visual separator between form and social buttons
  - [x] Ensure consistent styling with Login screen

- [x] Task 6: Implement error handling (AC: 6)
  - [x] Handle user cancellation of OAuth flow (dismissed modal)
  - [x] Handle network errors during OAuth
  - [x] Handle invalid/expired OAuth tokens
  - [x] Display user-friendly error messages

- [x] Task 7: Verify profile auto-creation (AC: 4)
  - [x] Test that existing `handle_new_user` trigger creates profile for OAuth users
  - [x] Verify profile contains email and name from OAuth provider
  - [x] Handle edge case where OAuth doesn't provide full_name (use email prefix)

- [x] Task 8: Write tests for OAuth functionality
  - [x] Test Google Sign-In button renders on LoginScreen
  - [x] Test Google Sign-In button renders on SignupScreen
  - [x] Test error handling UI displays correctly

## Dev Notes

### OAuth Configuration in Supabase

**Google OAuth setup (completed):**
1. Created credentials in Google Cloud Console
2. Authorized redirect URI: `https://aronbauecqiouxgdxmsh.supabase.co/auth/v1/callback`
3. Enabled Google provider in Supabase Dashboard > Authentication > Providers
4. Added app redirect URIs in Supabase:
   - `http://localhost:8081` (web development)
   - `http://localhost:8082` (web development alternate port)
   - `exp://192.168.1.36:8082/--/auth/callback` (Expo Go development)

**Apple OAuth:** Deferred until Apple Developer account is available.

### Key Implementation Details

**Critical Fix - setSession Hanging Issue:**

`supabase.auth.setSession()` hangs indefinitely in React Native/Expo Go environment. The solution is to:
1. Decode the JWT directly to extract user info
2. Fire `setSession()` without awaiting (fire-and-forget for session persistence)
3. Set user state immediately from decoded JWT

```typescript
// Extract tokens from callback URL
if (accessToken && refreshToken) {
  // Decode JWT directly - DO NOT await setSession (it hangs)
  const payload = JSON.parse(atob(accessToken.split('.')[1]));

  // Fire-and-forget: persists session for future app loads
  supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  // Set user immediately from JWT payload
  const userId = payload.sub;
  const email = payload.email || '';
  const userMetadata = payload.user_metadata || {};

  setUser({
    id: userId,
    email: email,
    full_name: userMetadata.full_name || userMetadata.name || email.split('@')[0] || '',
    avatar_url: userMetadata.avatar_url || userMetadata.picture || null,
    // ...
  });
}
```

**Platform-Specific Redirect URIs:**

```typescript
function getRedirectUri(): string {
  if (Platform.OS === 'web') {
    return window.location.origin;  // e.g., http://localhost:8081
  }
  return makeRedirectUri({
    scheme: 'laundryshare',
    path: 'auth/callback',
    preferLocalhost: false,  // Important for Expo Go
  });
}
```

### Source Tree (Implemented)

```
apps/mobile-web/src/
├── hooks/
│   ├── useAuth.ts              # Email/password auth + web OAuth callback
│   └── useOAuth.ts             # Google OAuth hook
├── screens/
│   └── auth/
│       ├── LoginScreen.tsx     # Updated with Google sign-in
│       └── SignupScreen.tsx    # Updated with Google sign-in
├── components/
│   └── auth/
│       ├── index.ts            # Exports GoogleSignInButton
│       └── GoogleSignInButton.tsx
└── services/
    └── supabase.ts
```

### Dependencies Installed

```bash
npx expo install expo-auth-session expo-crypto expo-web-browser
```

### Testing Notes

- OAuth tested on Expo Go (iOS) with real Google account
- Web callback handling tested with URL hash parsing
- Profile auto-creation works via `handle_new_user` trigger

### Important Notes

- Apple Sign-In deferred until Apple Developer account is available
- AC 5 (linking existing accounts) is "future enhancement - not MVP"
- Session persists correctly despite fire-and-forget approach
- On app reload, user is authenticated from persisted session

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-01-06 | 1.1 | Story approved for development | Sarah (PO) |
| 2026-01-06 | 2.0 | Implementation complete - Google OAuth hook, social button, error handling | Dev |
| 2026-01-06 | 2.1 | Removed Apple Sign-In (deferred), cleaned up debug logs, updated documentation with key implementation details including setSession fix | Dev |
